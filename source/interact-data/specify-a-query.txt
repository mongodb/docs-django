.. _django-specify-query:

===============
Specify a Query
===============

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

.. facet::
   :name: genre
   :values: reference

.. meta::
   :keywords: expressions, operations, read, filter, code example

Overview
--------

In this guide, you can learn how to use {+django-odm+} to specify
a database query.

The Django ``QuerySet`` API provides functions that allow you to retrieve
model objects. To run a MongoDB database query, create a ``QuerySet`` object
that specifies your query and the model you're querying. Then, {+django-odm+}
runs the operation on the MongoDB collection that the model represents.

When you assign a ``QuerySet`` object to a variable, {+django-odm+} does not
perform the operation until you evaluate the variable, usually by printing. After
evaluating the ``QuerySet``, Django saves the query results in the ``QuerySet``
cache. Future evaluations of the ``QuerySet`` reuse the cached results.

.. tip::

    To learn more about the Django ``QuerySet`` API, see `QuerySet API reference
    <{+django-docs+}/models/querysets/>`__ in the Django documentation.

You can refine the set of documents that a query returns by creating a
**query filter**. A query filter is an expression that specifies the search
criteria MongoDB uses to match documents in a read or write operation.
In a query filter, you can prompt {+django-odm+} to search for documents with an
exact match to your query, or you can compose query filters to express more
complex matching criteria.

Sample Data
~~~~~~~~~~~

The examples in this guide use the ``Movie`` model, which represents
the ``sample_mflix.movies`` collection from the :atlas:`Atlas sample datasets </sample-data>`.
The ``Movie`` model contains an embedded ``Award`` model as the value
of its ``awards`` field. These model classes have the following definitions:

.. literalinclude:: /includes/interact-data/specify-a-query.py
   :start-after: start-models
   :end-before: end-models
   :language: python
   :copyable:

You can use the Python interactive shell to run the code examples.
To enter the shell, run the following command from your project's 
root directory:

.. code-block:: bash

   python manage.py shell

After entering the Python shell, ensure that you import the following models and
modules:

.. code-block:: python

   from <your application name>.models import Movie, Award
   from django.utils import timezone
   from datetime import datetime

To learn how to create a Django application that uses the ``Movie``
model and the Python interactive shell to interact with MongoDB documents,
visit the :ref:`django-get-started` tutorial.

Run a Query
-----------

To query your MongoDB data, call a ``QuerySet`` function on the 
model that represents your collection and specify your matching
criteria in a query filter.

This section describes how to use the following functions from
the ``QuerySet`` API:

- :ref:`all() <django-query-retrieve-all>`
- :ref:`filter() <django-query-retrieve-matching>`
- :ref:`get() <django-query-retrieve-one>`
- :ref:`exclude() <django-query-exclude>`

.. _django-query-retrieve-all:

Retrieve All Documents
~~~~~~~~~~~~~~~~~~~~~~

To retrieve all documents from a collection, call the ``all()``
function on the collection's corresponding Django model.

The following example calls the ``all()`` function on the
``Movie`` model to retrieve all documents in the ``sample_mflix.movies``
collection:

.. io-code-block::
   :copyable:

   .. input:: /includes/interact-data/specify-a-query.py
      :start-after: start-all
      :end-before: end-all
      :language: python

   .. output::
      :visible: false

      <QuerySet [<Movie: The Great Train Robbery>, <Movie: A Corner in Wheat>,
      <Movie: Winsor McCay, the Famous Cartoonist of the N.Y. Herald and His Moving Comics>,
      <Movie: Traffic in Souls>, <Movie: Gertie the Dinosaur>,
      <Movie: In the Land of the Head Hunters>, <Movie: The Perils of Pauline>,
      <Movie: The Italian>, <Movie: Regeneration>, <Movie: Civilization>,
      <Movie: Where Are My Children?>, <Movie: The Poor Little Rich Girl>,
      <Movie: Wild and Woolly>, <Movie: The Blue Bird>, <Movie: From Hand to Mouth>,
      <Movie: High and Dizzy>, <Movie: One Week>, <Movie: The Saphead>,
      <Movie: The Ace of Hearts>, <Movie: The Four Horsemen of the Apocalypse>,
      '...(remaining elements truncated)...']>

.. _django-query-retrieve-matching:

Retrieve Matching Documents
~~~~~~~~~~~~~~~~~~~~~~~~~~~

To query a collection for documents that match a set of criteria,
call the ``filter()`` function on the collection's corresponding Django
model. Pass a query filter to the ``filter()`` function that specifies your
query criteria.

The following example calls the ``filter()`` function on the
``Movie`` model to query the ``sample_mflix.movies`` collection
for documents that have a ``runtime`` value of ``300``:

.. io-code-block::
   :copyable:

   .. input:: /includes/interact-data/specify-a-query.py
      :start-after: start-filter
      :end-before: end-filter
      :language: python

   .. output::
      :visible: false

      <QuerySet [<Movie: Wild Palms>, <Movie: Streets of Laredo>,
      <Movie: The Way We Live Now>]>

.. _django-query-retrieve-one:

Retrieve One Document
~~~~~~~~~~~~~~~~~~~~~

To retrieve one document from a collection, call the ``get()``
function on the collection's corresponding Django model. Pass 
a query filter to the ``get()`` function that specifies your
query criteria.

.. important::

   If your query matches no documents or multiple documents, the ``get()``
   function generates an error. To retrieve one document from a query
   that might match multiple, use the :ref:`first() <django-query-first>`
   function.


The following example calls the ``get()`` function on the
``Movie`` model to retrieve one document that has a ``title``
value of ``"Finding Nemo"``:

.. io-code-block::
   :copyable:

   .. input:: /includes/interact-data/specify-a-query.py
      :start-after: start-get
      :end-before: end-get
      :language: python

   .. output::
      :visible: false

      <Movie: Finding Nemo>

.. _django-query-exclude:

Exclude Matching Documents
~~~~~~~~~~~~~~~~~~~~~~~~~~

To query a collection for documents that do not meet your
search criteria, call the ``exclude()`` function on the collection's
corresponding Django model. Pass the exclusion criteria as an 
argument to the ``exclude()`` function.

The following example calls the ``exclude()`` function on the
``Movie`` model to exclude documents released before January 1,
1980 from the results:

.. io-code-block::
   :copyable:

   .. input:: /includes/interact-data/specify-a-query.py
      :start-after: start-exclude
      :end-before: end-exclude
      :language: python

   .. output::
      :visible: false

      <QuerySet [<Movie: The Iron Horse>, <Movie: Le grand jeu>,
      <Movie: The Devil Is a Woman>, <Movie: Children in the Wind>,
      <Movie: Too Much Johnson>, <Movie: Dots>, <Movie: The Blood of Jesus>,
      <Movie: The Land>, <Movie: The Brothers and Sisters of the Toda Family>,
      <Movie: People on the Alps>, <Movie: Der groèe Kènig>,
      <Movie: Kate & Leopold>, <Movie: Meshes of the Afternoon>,
      <Movie: The Body Snatcher>, <Movie: Let There Be Light>,
      <Movie: La porta del cielo>, <Movie: A Double Life>,
      <Movie: One Wonderful Sunday>, <Movie: La Terra Trema>,
      <Movie: Begone Dull Care>, '...(remaining elements truncated)...']>

.. tip::

   The preceding example uses the ``lt`` comparison operator
   to query the collection. To learn more about comparison
   operators, see the :ref:`django-query-comparison` section
   in this guide.

Customize Your Query Filter
---------------------------

You can further refine your query criteria by using a **field lookup**
in your query filter. Field lookups allow you to clarify the relationship
between the field you're querying and the value you want to
query for. Use the following syntax to specify a field lookup:

.. code-block:: python
   :copyable: false

   Model.objects.filter(<field name>__<lookup type>=<value>)
   
You can use different lookup types to perform advanced queries,
such as partial text matching, array element queries, regular
expression matching, and year value matching for datetime fields. 

.. tip::

   To view a full list of lookup types, see `Field lookups
   <{+django-docs+}/models/querysets/#field-lookups>`__ in the
   ``QuerySet`` Django documentation.

This section describes how to refine your query filters
in the following ways:

- :ref:`django-query-text-match`
- :ref:`django-query-comparison`
- :ref:`django-query-span-relationships`

.. _django-query-text-match:

Use Text Match Lookups
~~~~~~~~~~~~~~~~~~~~~~

The following table describes some of the lookup types
that you can use to run queries that include specific
matching criteria for text values:

.. list-table::
   :header-rows: 1
   :widths: 20 80

   * - Lookup Type
     - Description

   * - ``__exact``
     - | Specifies an exact text match. If you do not provide a 
         lookup type in your query filter, {+django-odm+} uses this
         type by default.
       
       | You can specify a case-insensitive exact text match
         by using ``__iexact``.
   * - ``__contains``
     - | Specifies a partial text match.
       
       | You can specify a case-insensitive partial text match
         by using ``__icontains``.
   * - ``__startswith``
     - | Matches field values that begin with the specified text.
       
       | You can specify a case-insensitive partial text match
         by using ``__istartswith``.
   * - ``__endswith``
     - | Matches field values that end with the specified text.
       
       | You can specify a case-insensitive partial text match
         by using ``__iendswith``.

Example
```````

The following example uses the ``__contains`` lookup to 
query for documents in which the ``plot`` value
includes the text ``"coming-of-age"``:

.. io-code-block::
   :copyable:

   .. input:: /includes/interact-data/specify-a-query.py
      :start-after: start-filter-contains
      :end-before: end-filter-contains
      :language: python

   .. output::
      :visible: false

      <QuerySet [<Movie: Murmur of the Heart>, <Movie: Desert Bloom>,
      <Movie: Girls Town>, <Movie: Get Real>, <Movie: Man of Steel>,
      <Movie: The Holy Land>, <Movie: Secondhand Lions>, <Movie: How to Be Louise>,
      <Movie: Mouth to Mouth>, <Movie: Che ne sarè di noi>, <Movie: Roll Bounce>,
      <Movie: Quando sei nato non puoi piè nasconderti>,
      <Movie: Hey Hey It's Esther Blueburger>, <Movie: A Guide to Recognizing Your Saints>,
      <Movie: Archie's Final Project>, <Movie: Persepolis>, <Movie: The Runaways>,
      <Movie: An Education>, <Movie: SoulBoy>, <Movie: The French Kissers>,
      '...(remaining elements truncated)...']>

.. _django-query-comparison:

Use Comparison Lookups
~~~~~~~~~~~~~~~~~~~~~~

The following table describes some of the lookup types
that you can use to run queries that include specific
matching criteria for text values:

.. list-table::
   :header-rows: 1
   :widths: 20 80

   * - Lookup Type
     - Description

   * - ``__gt``
     - | Matches field values that are greater than the
         specified value.

   * - ``__gte``
     - | Matches field values that are greater than or equal
         to the specified value.
       
   * - ``__lt``
     - | Matches field values that are less than the specified
         value.

   * - ``__lte``
     - | Matches field values that are less or equal to than the specified
         value.


Example
```````

The following example uses the ``__lte`` lookup to 
query for documents in which the ``runtime`` value
is less than or equal to ``50``:

.. io-code-block::
   :copyable:

   .. input:: /includes/interact-data/specify-a-query.py
      :start-after: start-filter-lte
      :end-before: end-filter-lte
      :language: python

   .. output::
      :visible: false

      <QuerySet [<Movie: The Great Train Robbery>, <Movie: A Corner in Wheat>,
      <Movie: Winsor McCay, the Famous Cartoonist of the N.Y. Herald and His Moving Comics>,
      <Movie: Gertie the Dinosaur>, <Movie: From Hand to Mouth>,
      <Movie: High and Dizzy>, <Movie: One Week>, <Movie: Now or Never>,
      <Movie: Steamboat Willie>, <Movie: The Music Box>, <Movie: Three Little Pigs>,
      <Movie: The Band Concert>, <Movie: Who Killed Cock Robin?>,
      <Movie: Popeye the Sailor Meets Sindbad the Sailor>, <Movie: Dots>, <Movie: The Land>,
      <Movie: Meshes of the Afternoon>, <Movie: The Memphis Belle: A Story of a Flying Fortress>,
      <Movie: Report from the Aleutians>, <Movie: Saludos Amigos>,
      '...(remaining elements truncated)...']>

.. _django-query-span-relationships:

Filter Across Relationships
~~~~~~~~~~~~~~~~~~~~~~~~~~~

You can run operations on your model that query fields of related
models. To query across relationships, specify each related field
name separated by double underscores (``__``) until you reach the 
field you want to query, as shown in the following code:

.. code-block:: python
   :copyable: false

   Model.objects.filter(<model field>__<related model field>=<value>)

Example
```````

This example uses a lookup that spans the ``Movie`` and ``Award``
relationship. The ``Movie`` model's ``awards`` field has an
embedded ``Award`` model value. This embedded model represents
the ``awards``  object field in the ``sample_mflix.movies`` collection
and its nested ``wins``,  ``nominations``, and ``text`` fields. The
following code uses a lookup to query for documents in which the ``awards.wins``
nested field value is ``93``:

.. io-code-block::
   :copyable:

   .. input:: /includes/interact-data/specify-a-query.py
      :start-after: start-filter-relationships
      :end-before: end-filter-relationships
      :language: python

   .. output::
      :visible: false

      <QuerySet [<Movie: The Queen>, <Movie: Dallas Buyers Club>]>

.. _django-query-combine:

Combine Lookups
~~~~~~~~~~~~~~~

You can combine field lookups to further specify your
query criteria. To combine lookups, chain each lookup
type together and separate them with a double underscore
(``__``).

Example
```````

The following example combines lookup types to query for documents
in which the value of the ``awards.text`` nested field
begins with the text ``"nominated"``, instructing 
{+django-odm+} to perform a case-insensitive text search: 

.. io-code-block::
   :copyable:

   .. input:: /includes/interact-data/specify-a-query.py
      :start-after: start-filter-combine
      :end-before: end-filter-combine
      :language: python

   .. output::
      :visible: false

      <QuerySet [<Movie: Hallelujah>, <Movie: Little Caesar>,
      <Movie: Morocco>, <Movie: Romance>, <Movie: The Guardsman>,
      <Movie: The Front Page>, <Movie: The Public Enemy>,
      <Movie: è Nous la Libertè>, <Movie: Smilin' Through>,
      <Movie: Flying Down to Rio>, <Movie: She Done Him Wrong>,
      <Movie: State Fair>, <Movie: The Barretts of Wimpole Street>,
      <Movie: Imitation of Life>, <Movie: The Lost Patrol>,
      <Movie: Alice Adams>, <Movie: Black Fury>, <Movie: David Copperfield>,
      <Movie: Les Misèrables>, <Movie: Roberta>,
      '...(remaining elements truncated)...']>

Modify Query Results
--------------------

This section describes how to modify your query
results in the following ways:

- :ref:`django-query-sort`
- :ref:`django-query-limit`
- :ref:`django-query-first`

.. _django-query-sort:

Sort Results
~~~~~~~~~~~~

You can provide a sort order for your query results by using the
``order_by()`` function. To specify an ascending sort based on values
of a given field, pass the field name as an argument. To specify a descending
sort, pass the field name prefixed with a minus symbol (``-``) as an argument.

Example
```````

This example performs the following actions:

- Calls the ``filter()`` function on the ``Movie`` model to query
  the ``sample_mflix.movies`` collection
- Queries documents that have a ``title`` value starting
  with the text ``"Rocky"``
- Sorts the results in ascending order of their ``released`` field
  values

.. io-code-block::
   :copyable:

   .. input:: /includes/interact-data/specify-a-query.py
      :start-after: start-sort
      :end-before: end-sort
      :language: python

   .. output::
      :visible: false

      <QuerySet [<Movie: Rocky>, <Movie: Rocky II>, <Movie: Rocky III>,
      <Movie: Rocky IV>, <Movie: Rocky V>, <Movie: Rocky Marciano>,
      <Movie: Rocky Balboa>]>

.. _django-query-limit:

Limit Results
~~~~~~~~~~~~~

You can specify the number of results that a query returns
by using Python's array-slicing syntax, as shown
in the following code:

.. code-block:: python
   :copyable: false

   Model.objects.filter(<query filter>)[<start>:<end>]

Replace the ``<start>`` and ``<end>`` placeholders with integer
values representing the subset of results you want to return.
The start value is non-inclusive and the end value is inclusive.

If you omit the ``<start>`` value, the query returns each result,
beginning with the first match, until it returns the number specified
by the ``<end>`` value.

If you omit the ``<end>`` value, the query returns each result
but skips the number of initial results specified by ``<start>``.

Example
```````

This example performs the following actions:

- Calls the ``filter()`` function on the ``Movie`` model to query
  the ``sample_mflix.movies`` collection
- Queries documents that have a ``released`` value of 
  ``datetime(2010, 7, 16)`` (July 16, 2010)
- Returns the third and fourth results

.. io-code-block::
   :copyable:

   .. input:: /includes/interact-data/specify-a-query.py
      :start-after: start-limit
      :end-before: end-limit
      :language: python

   .. output::
      :visible: false

      <QuerySet [<Movie: Inception>, <Movie: Winter's Bone>]>

.. _django-query-first:

Retrieve the First Result
~~~~~~~~~~~~~~~~~~~~~~~~~

To retrieve the first result from a query that might match
multiple results, chain the ``first()`` function to the ``filter()``
function. Pass a query filter to the ``filter()`` function that specifies your
query criteria.

The following example calls the ``filter()`` and ``first()`` functions on the
``Movie`` model to query the ``sample_mflix.movies`` collection
for the first document in which the ``genres`` value is 
``["Crime", "Comedy"]``:

.. io-code-block::
   :copyable:

   .. input:: /includes/interact-data/specify-a-query.py
      :start-after: start-first
      :end-before: end-first
      :language: python

   .. output::
      :visible: false

      <Movie: The Crew>


Advanced Field Queries
----------------------

This section describes how to run queries on the
following field types:

- :ref:`JSONField <django-query-jsonfield>`
- :ref:`Primary Key <django-query-primary-key>`

.. _django-query-jsonfield:

Query a JSONField
~~~~~~~~~~~~~~~~~

You can query data stored in a ``JSONField`` value by using the 
same syntax as show in the :ref:`django-query-span-relationships`
section. Chain each field and nested field name together, separated
by double underscores (``__``), until you reach the field you want
to query.

The following example queries the ``imdb`` field, a ``JSONField``,
for values of its nested ``votes`` field that exceed ``900000``:

.. io-code-block::
   :copyable:

   .. input:: /includes/interact-data/specify-a-query.py
      :start-after: start-json
      :end-before: end-json
      :language: python

   .. output::
      :visible: false

      <QuerySet [<Movie: La nao capitana>, <Movie: The Godfather>,
      <Movie: This Is Spinal Tap>, <Movie: Forrest Gump>, <Movie: Pulp Fiction>,
      <Movie: The Shawshank Redemption>, <Movie: Se7en>,
      <Movie: The Lord of the Rings: The Fellowship of the Ring>,
      <Movie: The Matrix>, <Movie: Fight Club>,
      <Movie: The Lord of the Rings: The Return of the King>,
      <Movie: The Lord of the Rings: The Two Towers>, <Movie: The Shawshank Redemption>,
      <Movie: Landet som icke èr>, <Movie: The Dark Knight>,
      <Movie: The Danish Girl>, <Movie: The Dark Knight Rises>, <Movie: Inception>,
      <Movie: Catching the Sun>, <Movie: Scouts Guide to the Zombie Apocalypse>,
      '...(remaining elements truncated)...']>

JSONField Transforms
````````````````````

You can use the ``KT()`` function to specify a key, index, or path
transform of a ``JSONField``. For example, the following code uses
the ``annotate()`` and ``KT()`` functions to create a new ``score`` key, which
stores ``imdb.rating`` nested field values. Then, the code sorts 
each document in the ``sample_mflix.movies`` collection by 
their descending ``score`` values:

.. io-code-block::
   :copyable:

   .. input:: /includes/interact-data/specify-a-query.py
      :start-after: start-kt
      :end-before: end-kt
      :language: python

   .. output::
      :visible: false

      <QuerySet [<Movie: No Tomorrow>, <Movie: The Deposit>, <Movie: Man Down>,
      <Movie: Convenience>, <Movie: Scouts Guide to the Zombie Apocalypse>,
      <Movie: Another World>, <Movie: The Danish Girl>, <Movie: Ad Inexplorata>,
      <Movie: Landet som icke èr>, <Movie: The Ghost and the Whale>,
      <Movie: Coming to Terms>, <Movie: La nao capitana>, <Movie: All Eyes and Ears>,
      <Movie: Catching the Sun>, <Movie: Manhattan Romance>, <Movie: Anomalisa>,
      <Movie: Outliving Emily>, <Movie: Mary Loss of Soul>,
      <Movie: The Childhood of a Leader>, <Movie: Krot na more>,
      '...(remaining elements truncated)...']>

.. _django-query-primary-key:

Query a Primary Key Field
~~~~~~~~~~~~~~~~~~~~~~~~~

You can use the ``pk`` lookup shortcut to query primary key
values, which MongoDB stores as ``ObjectId`` values.

The following example queries the ``sample_mflix.movies`` collection
for a document whose primary key is ``ObjectId("573a1394f29313caabce0d37")``:

.. io-code-block::
   :copyable:

   .. input:: /includes/interact-data/specify-a-query.py
      :start-after: start-primary-key-pk
      :end-before: end-primary-key-pk
      :language: python

   .. output::
      :visible: false
     
      // Your ObjectId values might differ

      <Movie: Vertigo>

The ``Movie`` model, which represents the ``sample_mflix.movies`` collection,
uses the ``id`` field as its primary key. The following example constructs
the same query as the preceding code:

.. io-code-block::
   :copyable:

   .. input:: /includes/interact-data/specify-a-query.py
      :start-after: start-primary-key-id
      :end-before: end-primary-key-id
      :language: python

   .. output::
      :visible: false
     
      // Your ObjectId values might differ

      <Movie: Vertigo>

Additional Information
----------------------

To learn how to run raw database queries using MongoDB's aggregation 
pipeline syntax, rather than ``QuerySet`` API functions, see the
:ref:`django-raw-queries` guide.

To learn how to perform other ``QuerySet`` operations, see the
:ref:`django-crud` guide.

To learn more about Django queries, see `Making queries <{+django-docs+}/topics/db/queries>`__
in the Django documentation.
